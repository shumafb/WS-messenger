<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Chat Demo</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 0 auto; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; }
    .msg { margin-bottom: 8px; }
    .pending { opacity: 0.5; }
    #status { color: gray; font-size: 0.9em; }
  </style>
</head>
<body>
  <div id="login">
    <h2>Вход</h2>
    <form id="login-form">
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Пароль" required />
      <button type="submit">Войти</button>
    </form>
  </div>
  <div id="chat" style="display:none;">
  <h1>Чат</h1>
  <div id="status">Подключаемся...</div>
  <div id="messages"></div>
  <form id="form">
    <input id="input" autocomplete="off" placeholder="Сообщение…" /><button>Отправить</button>
  </form>
  </div>

  <script>
    // ==== Настройки ====
    const tokenKey = 'token';
    let token = localStorage.getItem(tokenKey);
    const loginDiv = document.getElementById('login');
    const chatDiv = document.getElementById('chat');
    const chatId = 123;                            // ваш chat_id
    const apiBase = 'http://127.0.0.1:8000';
    const wsUrl = `ws://127.0.0.1:8000/ws/${chatId}?token=${token}`;

    // ==== Элементы DOM ====
    const statusEl   = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const form       = document.getElementById('form');
    const input      = document.getElementById('input');

    // ==== Словарь для дедубликации ====
    const seenClientIds = new Set();

    // ==== WebSocket ====
    let socket;
    let reconnectAttempts = 0;

    function connect() {
      socket = new WebSocket(wsUrl);

      socket.addEventListener('open', () => {
        statusEl.textContent = 'Онлайн';
        reconnectAttempts = 0;
        loadHistory();  // сразу подгружаем историю
      });

      socket.addEventListener('message', evt => {
        const data = JSON.parse(evt.data);
        handleSocketEvent(data);
      });

      socket.addEventListener('close', () => {
        statusEl.textContent = 'Отключено, переподключаемся…';
        const delay = Math.min(1000 * 2 ** reconnectAttempts, 10000);
        setTimeout(connect, delay);
        reconnectAttempts++;
      });
    }

    // connect(); // removed direct call, will be called in startChat()

    // ==== Загрузка истории ====
    async function loadHistory(limit = 50, offset = 0) {
      const res = await fetch(`${apiBase}/history/${chatId}?limit=${limit}&offset=${offset}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const msgs = await res.json();
      messagesEl.innerHTML = '';  // сбрасываем, или можно prepend при пагинации
      msgs.forEach(m => renderIncomingMessage(m));
      scrollToBottom();
    }

    function startChat() {
      connect();
    }

    // ==== Отправка нового сообщения ====
    function generateClientId() {
      return `${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      const cid = generateClientId();
      // optimistic UI
      renderIncomingMessage({ sender_id: 'me', text, client_message_id: cid }, true);
      socket.send(JSON.stringify({ type: 'message', client_message_id: cid, text }));
      input.value = '';
    });

    // ==== Обработка входящих событий ====
    function handleSocketEvent(data) {
      switch (data.type) {
        case 'message':
          // дедубликация по client_message_id
          if (seenClientIds.has(data.client_message_id)) return;
          seenClientIds.add(data.client_message_id);
          updatePending(data.client_message_id, data);  // заменяем «pending» на реальное сообщение
          break;

        case 'read':
          markAsReadInUI(data.message_id);
          break;
      }
    }

    // ==== Отрисовка сообщений ====
    function renderIncomingMessage(m, pending = false) {
      const div = document.createElement('div');
      div.className = 'msg' + (pending ? ' pending' : '');
      div.dataset.clientId = m.client_message_id;
      div.dataset.messageId = m.message_id || '';
      div.textContent = `[${m.sender_id}] ${m.text}`;
      messagesEl.append(div);
      // после рендеринга — сообщаем серверу о прочтении
      if (!pending && m.message_id) {
        socket.send(JSON.stringify({ type: 'read', message_id: m.message_id }));
      }
      scrollToBottom();
    }

    function updatePending(clientId, real) {
      const el = messagesEl.querySelector(`.msg.pending[data-client-id="${clientId}"]`);
      if (!el) {
        // если нет, просто отрисовать как новое
        renderIncomingMessage(real);
        return;
      }
      el.classList.remove('pending');
      el.dataset.messageId = real.message_id;
      el.textContent = `[${real.sender_id}] ${real.text}`;
      el.dataset.clientId = clientId;
    }

    function markAsReadInUI(messageId) {
      const el = messagesEl.querySelector(`.msg[data-message-id="${messageId}"]`);
      if (el) el.style.opacity = '0.6';  // визуальный маркер «прочитано»
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    // ==== UI Initialization & Login Logic ====
    if (!token) {
      loginDiv.style.display = 'block';
      chatDiv.style.display = 'none';
    } else {
      loginDiv.style.display = 'none';
      chatDiv.style.display = 'block';
      startChat();
    }

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const res = await fetch(`${apiBase}/login`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email, password})
      });
      if (res.ok) {
        const data = await res.json();
        localStorage.setItem(tokenKey, data.access_token);
        token = data.access_token;
        loginDiv.style.display = 'none';
        chatDiv.style.display = 'block';
        startChat();
      } else {
        alert('Не удалось войти');
      }
    });
  </script>
</body>
</html>