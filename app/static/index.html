<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мессенджер</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      display: flex;
      height: 100%;
      flex: 1;
    }
    
    /* Auth forms */
    .auth-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .auth-box {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .auth-title {
      margin-bottom: 20px;
      color: #333;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      background-color: #4a76a8;
      color: white;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    
    .btn:hover {
      background-color: #3d6293;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mt-3 {
      margin-top: 15px;
    }
    
    .auth-switch {
      color: #4a76a8;
      cursor: pointer;
      text-decoration: underline;
    }
    
    /* Chat sidebar */
    .sidebar {
      width: 300px;
      background-color: #fff;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      flex: 1;
    }
    
    .logout-btn {
      background: none;
      border: none;
      color: #f44336;
      cursor: pointer;
      font-size: 14px;
    }
    
    .new-chat-btn {
      padding: 10px 15px;
      margin: 15px;
      background-color: #4a76a8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chats-list {
      flex: 1;
      overflow-y: auto;
    }
    
    .chat-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-item:hover {
      background-color: #f5f5f5;
    }
    
    .chat-item.active {
      background-color: #e3f2fd;
    }
    
    .chat-name {
      font-weight: 500;
      color: #333;
      flex: 1;
    }
    
    .leave-chat {
      color: #f44336;
      cursor: pointer;
      font-size: 18px;
      margin-left: 10px;
    }
    
    /* Chat main */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      background-color: #fff;
      justify-content: space-between;
    }
    
    .current-chat-name {
      font-weight: bold;
      font-size: 18px;
      color: #333;
    }

    .chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background-color: #f5f5f5;
    }
    
    .message {
      margin-bottom: 15px;
      max-width: 70%;
      padding: 10px;
      border-radius: 8px;
      position: relative;
      word-wrap: break-word;
      display: flex;
      flex-direction: column;
    }
    
    .message.incoming {
      background-color: #fff;
      align-self: flex-start;
      border-top-left-radius: 0;
      margin-right: auto;
    }
    
    .message.outgoing {
      background-color: #e3f2fd;
      align-self: flex-end;
      border-top-right-radius: 0;
      margin-left: auto;
    }
    
    .message.pending {
      opacity: 0.6;
    }
    
    .message.read .message-text::after {
      content: ' ✓✓';
      color: #4a76a8;
      margin-left: 5px;
      font-size: 12px;
    }
    
    .message-sender {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .message-text {
      font-size: 14px;
      color: #333;
    }
    
    .message-time {
      font-size: 11px;
      color: #999;
      text-align: right;
      margin-top: 4px;
    }
    
    .chat-form {
      padding: 15px;
      border-top: 1px solid #ddd;
      display: flex;
      background-color: #fff;
    }
    
    .chat-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 10px;
    }
    
    .send-btn {
      padding: 10px 15px;
      background-color: #4a76a8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    
    .checkbox-group label {
      margin-left: 10px;
      margin-bottom: 0;
    }
    
    .user-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    
    .welcome-message {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <!-- Authentication Container -->
  <div id="auth-container" class="auth-container">
    <div class="auth-box">
      <div id="login-form-container">
        <h2 class="auth-title">Вход в систему</h2>
        <form id="login-form">
          <div class="form-group">
            <label for="login-email">Email</label>
            <input type="email" id="login-email" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="login-password">Пароль</label>
            <input type="password" id="login-password" class="form-control" required>
          </div>
          <div class="text-center">
            <button type="submit" class="btn">Войти</button>
          </div>
          <div class="text-center mt-3">
            Нет аккаунта? <span class="auth-switch" id="show-register">Регистрация</span>
          </div>
        </form>
      </div>
      <div id="register-form-container" style="display: none;">
        <h2 class="auth-title">Регистрация</h2>
        <form id="register-form">
          <div class="form-group">
            <label for="register-name">Имя</label>
            <input type="text" id="register-name" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="register-email">Email</label>
            <input type="email" id="register-email" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="register-password">Пароль</label>
            <input type="password" id="register-password" class="form-control" required>
          </div>
          <div class="text-center">
            <button type="submit" class="btn">Зарегистрироваться</button>
          </div>
          <div class="text-center mt-3">
            Уже есть аккаунт? <span class="auth-switch" id="show-login">Войти</span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Main Chat Interface -->
  <div class="container" id="chat-container" style="display: none;">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="user-info" id="user-name">Загрузка...</div>
        <button class="logout-btn" id="logout-btn">Выйти</button>
      </div>
      <button class="new-chat-btn" id="new-chat-btn">+ Новый чат</button>
      <div class="chats-list" id="chats-list">
        <!-- Список чатов -->
      </div>
    </div>
    
    <!-- Main chat area -->
    <div class="chat-main">
      <div id="welcome-screen" class="welcome-message">
        Выберите чат или создайте новый
      </div>
      <div id="chat-area" style="display: none; flex: 1; flex-direction: column;">
        <div class="chat-header">
          <div class="current-chat-name" id="current-chat-name">Загрузка...</div>
        </div>
        <div class="chat-messages" id="messages">
          <!-- Сообщения -->
        </div>
        <form class="chat-form" id="message-form">
          <input type="text" class="chat-input" id="message-input" placeholder="Напишите сообщение..." autocomplete="off">
          <button type="submit" class="send-btn">Отправить</button>
        </form>
      </div>
    </div>
  </div>

  <!-- New Chat Modal -->
  <div class="modal" id="new-chat-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Создать новый чат</h3>
        <button class="modal-close" id="close-modal">&times;</button>
      </div>
      <form id="new-chat-form">
        <div class="form-group">
          <label for="chat-name">Название чата</label>
          <input type="text" id="chat-name" class="form-control" required>
        </div>
        <div class="checkbox-group">
          <input type="checkbox" id="is-group-chat">
          <label for="is-group-chat">Групповой чат</label>
        </div>
        <div class="form-group" id="user-select-container" style="display: none;">
          <label for="user-select">Выберите пользователей</label>
          <select multiple id="user-select" class="user-select" style="height: 150px;">
            <!-- Загружаются пользователи -->
          </select>
        </div>
        <div class="form-group" id="user-select-single">
          <label for="user-single">Выберите пользователя</label>
          <select id="user-single" class="form-control">
            <!-- Загружаются пользователи -->
          </select>
        </div>
        <div class="text-center">
          <button type="submit" class="btn">Создать чат</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const apiBase = window.location.origin;
    const tokenKey = 'chat_token';
    const userDataKey = 'chat_user_data';

    const authContainer = document.getElementById('auth-container');
    const chatContainer = document.getElementById('chat-container');
    const loginFormContainer = document.getElementById('login-form-container');
    const registerFormContainer = document.getElementById('register-form-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegisterBtn = document.getElementById('show-register');
    const showLoginBtn = document.getElementById('show-login');
    const userName = document.getElementById('user-name');
    const logoutBtn = document.getElementById('logout-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const chatsList = document.getElementById('chats-list');
    const welcomeScreen = document.getElementById('welcome-screen');
    const chatArea = document.getElementById('chat-area');
    const currentChatName = document.getElementById('current-chat-name');
    const messagesContainer = document.getElementById('messages');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const newChatModal = document.getElementById('new-chat-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const newChatForm = document.getElementById('new-chat-form');
    const isGroupChat = document.getElementById('is-group-chat');
    const userSelectContainer = document.getElementById('user-select-container');
    const userSelectSingle = document.getElementById('user-select-single');
    const userSelect = document.getElementById('user-select');
    const userSingle = document.getElementById('user-single');

    let token = localStorage.getItem(tokenKey);
    let userData = JSON.parse(localStorage.getItem(userDataKey) || '{}');
    let currentUser = null;
    let currentChat = null;
    let chats = [];
    let users = [];
    let socket = null;
    let seenClientIds = new Set();

    init();

    function init() {
      if (token) {
        loadUserData()
          .then(() => {
            showChatInterface();
            loadChats();
          })
          .catch(() => logout());
      } else {
        showAuthInterface();
      }
      setupEventListeners();
    }

    function setupEventListeners() {
      showRegisterBtn.addEventListener('click', () => {
        loginFormContainer.style.display = 'none';
        registerFormContainer.style.display = 'block';
      });
      showLoginBtn.addEventListener('click', () => {
        registerFormContainer.style.display = 'none';
        loginFormContainer.style.display = 'block';
      });
      loginForm.addEventListener('submit', handleLogin);
      registerForm.addEventListener('submit', handleRegister);
      logoutBtn.addEventListener('click', logout);

      newChatBtn.addEventListener('click', showNewChatModal);
      closeModalBtn.addEventListener('click', hideNewChatModal);
      newChatForm.addEventListener('submit', handleCreateChat);
      messageForm.addEventListener('submit', handleSendMessage);

      isGroupChat.addEventListener('change', function() {
        if (this.checked) {
          userSelectContainer.style.display = 'block';
          userSelectSingle.style.display = 'none';
        } else {
          userSelectContainer.style.display = 'none';
          userSelectSingle.style.display = 'block';
        }
      });
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      try {
        const res = await fetch(`${apiBase}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!res.ok) throw new Error('Не удалось войти');
        const data = await res.json();
        token = data.access_token;
        localStorage.setItem(tokenKey, token);
        await loadUserData();
        showChatInterface();
        loadChats();
      } catch (err) {
        alert(err.message);
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      try {
        const res = await fetch(`${apiBase}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });
        if (!res.ok) throw new Error('Не удалось зарегистрироваться');
        const loginRes = await fetch(`${apiBase}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!loginRes.ok) throw new Error('Регистрация успешна, но не удалось войти');
        const data = await loginRes.json();
        token = data.access_token;
        localStorage.setItem(tokenKey, token);
        await loadUserData();
        showChatInterface();
        loadChats();
      } catch (err) {
        alert(err.message);
      }
    }

    async function loadUserData() {
      const res = await fetch(`${apiBase}/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) throw new Error();
      userData = await res.json();
      currentUser = userData;
      localStorage.setItem(userDataKey, JSON.stringify(userData));
      userName.textContent = userData.name;
    }

    function logout() {
      localStorage.removeItem(tokenKey);
      localStorage.removeItem(userDataKey);
      token = null;
      currentUser = null;
      if (socket) socket.close();
      showAuthInterface();
    }

    function showAuthInterface() {
      authContainer.style.display = 'flex';
      chatContainer.style.display = 'none';
    }

    function showChatInterface() {
      authContainer.style.display = 'none';
      chatContainer.style.display = 'flex';
    }

    async function loadChats() {
      try {
        const res = await fetch(`${apiBase}/chats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error();
        chats = await res.json();
        renderChatsList();
      } catch {
        alert('Не удалось загрузить чаты');
      }
    }

    function renderChatsList() {
      chatsList.innerHTML = '';
      if (chats.length === 0) {
        const empty = document.createElement('div');
        empty.textContent = 'У вас пока нет чатов';
        empty.style.padding = '15px';
        chatsList.appendChild(empty);
        return;
      }
      chats.forEach(chat => {
        const item = document.createElement('div');
        item.className = 'chat-item';
        if (currentChat && currentChat.id === chat.id) item.classList.add('active');
        const name = document.createElement('div');
        name.className = 'chat-name';
        name.textContent = chat.name;
        const leave = document.createElement('div');
        leave.className = 'leave-chat';
        leave.innerHTML = '&times;';
        leave.addEventListener('click', e => {
          e.stopPropagation();
          leaveChat(chat.id);
        });
        item.append(name, leave);
        item.addEventListener('click', () => openChat(chat));
        chatsList.appendChild(item);
      });
    }

    async function openChat(chat) {
      if (currentChat && currentChat.id === chat.id) return;
      if (socket) socket.close();
      currentChat = chat;
      currentChatName.textContent = chat.name;
      document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
      const idx = chats.findIndex(c => c.id === chat.id);
      if (idx >= 0) document.querySelectorAll('.chat-item')[idx].classList.add('active');
      welcomeScreen.style.display = 'none';
      chatArea.style.display = 'flex';
      messagesContainer.innerHTML = '';
      connectWebSocket(chat.id);
      await loadChatHistory(chat.id);
    }

    async function loadChatHistory(chatId) {
      try {
        const res = await fetch(`${apiBase}/chats/${chatId}/messages?limit=50&offset=0`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error();
        const data = await res.json();
        messagesContainer.innerHTML = '';
        if (data.items.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'welcome-message';
          empty.textContent = 'Нет сообщений';
          messagesContainer.appendChild(empty);
          return;
        }
        data.items.forEach(msg => renderMessage(msg, false));
        scrollToBottom();
      } catch {
        alert('Не удалось загрузить историю');
      }
    }

    function connectWebSocket(chatId) {
      if (!token) return;
      const wsUrl = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/${chatId}?token=${token}`;
      socket = new WebSocket(wsUrl);
      socket.addEventListener('message', e => {
        const data = JSON.parse(e.data);
        if (data.type === 'message') {
          if (seenClientIds.has(data.client_message_id)) {
            updatePendingMessage(data);
          } else {
            renderMessage({
              id: data.id,
              chat_id: data.chat_id,
              sender_id: data.sender_id,
              text: data.text,
              timestamp: data.timestamp,
              client_message_id: data.client_message_id,
              created_at: data.timestamp
            }, false);
            if (data.sender_id !== currentUser.id) {
              markMessageAsRead(data.id);
            }
          }
        }
      });
    }

    function handleSendMessage(e) {
      e.preventDefault();
      if (!currentChat || !socket || socket.readyState !== WebSocket.OPEN) {
        alert('Нет подключения к чату');
        return;
      }
      const text = messageInput.value.trim();
      if (!text) return;
      const clientId = generateClientId();
      // оптимистичное добавление
      renderMessage({
        sender_id: currentUser.id,
        text,
        timestamp: new Date().toISOString(),
        client_message_id: clientId
      }, true);
      seenClientIds.add(clientId);
      socket.send(JSON.stringify({ type: 'message', text, client_message_id: clientId }));
      messageInput.value = '';
    }

    function generateClientId() {
      return 'cid-' + Math.random().toString(36).substr(2, 9);
    }

    function renderMessage(message, pending) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message');
      msgDiv.classList.add(message.sender_id === currentUser.id ? 'outgoing' : 'incoming');
      if (pending) msgDiv.classList.add('pending');
      if (message.client_message_id) msgDiv.dataset.clientMessageId = message.client_message_id;
      if (message.message_id) msgDiv.dataset.messageId = message.message_id;

      const senderDiv = document.createElement('div');
      senderDiv.className = 'message-sender';
      senderDiv.textContent = message.sender_id === currentUser.id ? 'Вы' : '';
      const textDiv = document.createElement('div');
      textDiv.className = 'message-text';
      textDiv.textContent = message.text;
      const timeDiv = document.createElement('div');
      timeDiv.className = 'message-time';
      timeDiv.textContent = new Date(message.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

      msgDiv.append(senderDiv, textDiv, timeDiv);
      messagesContainer.appendChild(msgDiv);
      scrollToBottom();
    }

    function updatePendingMessage(data) {
      const el = document.querySelector(`.message[data-client-message-id="${data.client_message_id}"]`);
      if (!el) return;
      el.dataset.messageId = data.message_id;
      el.classList.remove('pending');
      if (data.is_read) el.classList.add('read');
    }

    function updateMessageReadStatus(messageId) {
      const el = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (el) el.classList.add('read');
    }

    function markMessageAsRead(messageId) {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: 'read', message_id: messageId }));
      }
    }

    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function leaveChat(chatId) {
      try {
        await fetch(`${apiBase}/chats/${chatId}/leave`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        chats = chats.filter(c => c.id !== chatId);
        if (currentChat && currentChat.id === chatId) {
          currentChat = null;
          chatArea.style.display = 'none';
          welcomeScreen.style.display = 'flex';
        }
        renderChatsList();
      } catch {
        alert('Не удалось выйти из чата');
      }
    }

    function showNewChatModal() {
      loadUsers();
      newChatModal.classList.add('show');
    }

    function hideNewChatModal() {
      newChatModal.classList.remove('show');
    }

    async function loadUsers() {
      try {
        const res = await fetch(`${apiBase}/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error();
        users = await res.json();
        users = users.filter(u => u.id !== currentUser.id);
        userSelect.innerHTML = '';
        userSingle.innerHTML = '';
        users.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id; opt.textContent = u.name;
          userSelect.append(opt);
          const opt2 = opt.cloneNode(true);
          userSingle.append(opt2);
        });
      } catch {
        alert('Не удалось загрузить пользователей');
      }
    }

    async function handleCreateChat(e) {
      e.preventDefault();
      const name = document.getElementById('chat-name').value.trim();
      const group = isGroupChat.checked;
      const selected = group
        ? Array.from(userSelect.selectedOptions).map(o => parseInt(o.value))
        : [parseInt(userSingle.value)];
      try {
        const res = await fetch(`${apiBase}/chats`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            name,
            chat_type: group ? 'group' : 'private',
            member_ids: selected
          })
        });
        if (!res.ok) throw new Error();
        const newChat = await res.json();
        chats.push(newChat);
        renderChatsList();
        hideNewChatModal();
        openChat(newChat);
      } catch {
        alert('Не удалось создать чат');
      }
    }
  </script>
</body>
</html>